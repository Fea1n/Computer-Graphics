## 话题1 回顾 阴影映射

实现的两大痛点：其一要进行两次pass
第一次pass 从光线 渲染 
第二次pass 投射视线到 光线

两大问题

1：自遮挡问题
因为阴影贴图的分辨率有限，导致多个采样点采样同一深度，导致阴影失真（shadow acne）初步措施是给像素z添加bias，但会导致阴影悬浮(peter panning),

课件方案：使用glfullface(正面生成深度贴图) 但需要目标具有水密性,再添加glpolygonoffset来解决问题

2：锯齿 
使用背面剔除可以将该缺陷隐藏
在进行风格化的渲染时，可以通过添加硬阴影（为阴影边缘添加统一的深度值）来简单解决、】



## 话题2 数学基础

重要的积分不等式

<img src="http://47.100.78.17:3403/i/2022/05/28/6291a0ead2072.png" alt="img" style="zoom:50%;" />

光照不等式变体

<img src="http://47.100.78.17:3403/i/2022/05/28/6291a100bc92f.png" alt="img" style="zoom:50%;" />

注：在P2 环境光照中会再次提及



## 话题3 PCF PCSS 百分比接近软阴影 

### PCF( percentage closer fiiltering ) 

> PCF提供阴影的边缘抗锯齿，并非是软阴影
>
> PCF不是filter 已经有锯齿的阴影，也不是filter shadow map，而是对该像素点周围的点进行比较是否遮挡后的结果进行filter

PCF 算法

- 步骤1：将该像素的深度与其filterbox中其他像素的深度进行比较
- 步骤2：得到比较结果
- 步骤3：取该filter box所有像素的均值作为该像素的可见性

<img src="http://47.100.78.17:3403/i/2022/05/29/6293943a59537.png" alt="image-20220529234145272" style="zoom:33%;" />



现象：大filiter box使得阴影更软，小filterbox更锐利，

结论：filter box的大小参数与阴影的软硬相关, 阴影的软硬取决与投影面与遮挡物的距离，即Filter Size <->Blocker distance

数学转换：

<img src="http://47.100.78.17:3403/i/2022/05/29/62939466e1cc7.png" alt="image-20220529234229994" style="zoom: 50%;" />

w 一定程度上表示阴影的软硬，即半影



### PCSS（percentage closer soft shadows）

> 用pcf做软阴影即pcss

PCSS 算法

- 步骤1：遮挡物搜索：在一定区域中得到遮挡物的平均深度
- 步骤2：半影（penumbra）估计，使用遮挡物平均深度估计（半影，由不透明对象投射的阴影的部分阴影外部区域。）
- 步骤3：PCF



## 话题4  深入 PCF PCSS 

> 慢的原因 第一步和第三步都需要进行比较，遍历每个点，取决于像素采样的快慢，故加速pcss过程需要对采样进行优化
>
> 边缘会闪烁（flicker）

<img src="http://47.100.78.17:3403/i/2022/05/28/629240355c2c4.png" alt="image-20220528233100525" style="zoom: 25%;" />

卷积得到周围点的加权平均，进行模糊处理



<img src="http://47.100.78.17:3403/i/2022/05/28/62924092ebeb8.png" alt="image-20220528233234002" style="zoom:25%;" />



在PCSS中

<img src="http://47.100.78.17:3403/i/2022/05/28/629240aca131a.png" alt="image-20220528233259886" style="zoom: 25%;" />

左部为卷积函数，右部为符号函数（chi）取值只有0,1（变量大于0时，值为1），得到可见性，最终结果即为P点的PCSS值

<img src="http://47.100.78.17:3403/i/2022/05/28/62924300cca2c.png" alt="image-20220528234256102" style="zoom: 25%;" />

PCF不是在过滤阴影贴图，和shadow map比较的值只有非0即1

<img src="http://47.100.78.17:3403/i/2022/05/28/629243755983e.png" alt="image-20220528234452628" style="zoom: 25%;" />

PCF也不是在图像层面处理，过滤硬阴影

> 空间域的卷积就是加权平均

步骤慢的原因：

- 需要查看区域内的每个纹理像素的深度，如果离散采样会造成噪声
- 更软的阴影 --> 更大的的过滤区域 --> 更慢

工业界做法：两次稀疏采样，最后在图像空间做一个降噪（使用在时间上的低通滤波）



## 话题5 VSSM 方差软阴影

出发点：percentage closer是为了找到比shadingpoint的深度更浅的点的百分比，为此需要把所有点都看一遍

通过方差和均值得到采样点的正态分布曲线，可得到全部点的分布曲线，即可得到当前点的百分比

关键在于快速得到该区域的均值和方差

均值可以通过hardware mipmaping快速得到,mipmap快速获得就层数的均值，在不同的层级中做插值，只能正方形，不准确

更精准的求均值方法：Summed Area Tables (SAT)

方差通过当前的depth的均值和均值的平方项（在获得shadowmap的同时获得square-depth map）求得

由此得到正态分布曲线PDF，得到x邻域中比x更近的纹素的比例，即计算得到x的CDF值

<img src="http://47.100.78.17:3403/i/2022/05/29/6292d9924bc7b.png" alt="image-20220529102521793" style="zoom: 33%;" />

计算细节：高斯PDF（比正太分布PDF更精准）积分后的值打表得值的分布(error function 误差函数)，无解析解只有数值解



切比雪夫不等式（优点：不需要知道具体分布类型，只需均值和方差即可），求得上界

<img src="http://47.100.78.17:3403/i/2022/05/29/6292dbdf94a63.png" alt="image-20220529103511170" style="zoom:33%;" />

<img src="http://47.100.78.17:3403/i/2022/05/29/6292dc8f66080.png" alt="image-20220529103806863" style="zoom:50%;" />

步骤3执行：求得范围内深度均值，深度平方的均值，最后切比雪夫不等式得到visiability（不需要采样和循环）

问题来到步骤1

采样点，获取当前所有点的深度，通过mipmap或者sat得到均值

<img src="http://47.100.78.17:3403/i/2022/05/29/6292e53e0574c.png" alt="image-20220529111509569" style="zoom:33%;" />

通过下式

<img src="http://47.100.78.17:3403/i/2022/05/29/6292e509a3438.png" alt="image-20220529111417237" style="zoom:33%;" />

假设Zunocc的深度都为当前深度 t (因为阴影的接受面大多数时候是平面)，通过切比雪夫得到N1/N，N2/N，然后即可得到Zocc的平均深度

> 背景：PCSS的热度渐渐压过VSSM，虽然噪声存在，但目前在图像空间和时间域的降噪很好，可以消除噪声



## 话题6 MIPMAP 和 Summed-Area Variance Shadow Maps

### MIPMAP

定义：快速的 近似的 方形的 查询 三线性插值，各向异性过滤

缺点：
只能表示方形区域
不能对圆形区域进行快速求平均

### SAT

![image-20220529213950862](http://47.100.78.17:3403/i/2022/05/29/629377a7c28b3.png)

前缀和在二维的解决方法：从左上角加到当前位置的值，每一行加一遍，每一列再加一遍

算法重点：提高并行度



## 话题7 Moment shadow mapping 

> 解决VSSM的缺点
>

<img src="http://47.100.78.17:3403/i/2022/05/29/62937a95bef74.png" alt="image-20220529215220525" style="zoom:33%;" />

<img src="http://47.100.78.17:3403/i/2022/05/29/62937b58405c4.png" alt="image-20220529215535116" style="zoom:33%;" />

如上图，穿过三个遮挡物时会产生三个遮挡物的正态分布，会产生lignt leaking(漏光)的现象

moment shadow mapping 解决vssm描述阴影不准确的问题,使用更高阶的矩（vssm只使用了前两阶的矩）（moments）



<img src="http://47.100.78.17:3403/i/2022/05/29/6293834c2dfb4.png" alt="image-20220529222931194" style="zoom:33%;" />

保留前m阶矩可以得到表示m/2的阶的CDF，类似泰勒展开的计算方法，存储用拼接packing 和unpacking



闲聊：[神经渲染](https://zhuanlan.zhihu.com/p/130239269)的发展迅猛

